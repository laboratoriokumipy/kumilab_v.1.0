<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorios Kumi - Productos Naturales y Medicinales</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --color-bg-primary: #0a1929;
            --color-bg-secondary: #102a3d;
            --color-bg-card: rgba(16, 42, 61, 0.7);
            --color-text-primary: #e6f1ff;
            --color-text-muted: #8892b0;
            --color-accent: #64ffda;
            --color-border: #233554;
            --color-success: #00d68f;
            --color-warning: #ffaa00;
            --color-danger: #ff3d71;
            --color-info: #0099ff;
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            color: var(--color-text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* --- Layout --- */
        header {
            background: rgba(10, 25, 41, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent);
            text-decoration: none;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        nav a {
            color: var(--color-text-primary);
            text-decoration: none;
            transition: var(--transition);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
        }

        nav a:hover {
            color: var(--color-accent);
            background: rgba(100, 255, 218, 0.1);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-size: 1rem;
        }

        .icon-btn:hover {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
            transform: translateY(-2px);
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-danger);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        main {
            padding: 2rem 0;
        }

        section {
            margin-bottom: 4rem;
        }

        .section-title {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--color-accent), #00bfa5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            text-align: center;
            color: var(--color-text-muted);
            margin-bottom: 3rem;
        }

        footer {
            text-align: center;
            padding: 2rem 0;
            border-top: 1px solid var(--color-border);
            color: var(--color-text-muted);
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--color-accent);
            color: var(--color-bg-primary);
        }

        .btn-primary:hover {
            background: #4cd4b8;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }

        .btn-secondary:hover {
            background: var(--color-accent);
            color: var(--color-bg-primary);
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e63566;
        }

        .btn-outline {
            background: transparent;
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .btn-outline:hover {
            background: var(--color-bg-card);
            border-color: var(--color-text-primary);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-family: inherit;
            transition: var(--transition);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* --- Modals --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover {
            color: var(--color-danger);
        }

        /* --- Product Grid --- */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .product-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-accent);
        }

        .product-image-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .product-card:hover .product-image-container img {
            transform: scale(1.1);
        }

        .product-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .product-card:hover .product-actions {
            opacity: 1;
        }

        .product-actions .icon-btn {
            background: rgba(10, 25, 41, 0.8);
            backdrop-filter: blur(5px);
        }

        .product-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--color-danger);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .product-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-category {
            font-size: 0.875rem;
            color: var(--color-info);
            margin-bottom: 0.5rem;
        }

        .product-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            flex-grow: 1;
        }

        .product-description {
            color: var(--color-text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-accent);
        }

        /* --- Carousel --- */
        .image-carousel {
            position: relative;
            margin-bottom: 1rem;
        }

        .carousel-main {
            position: relative;
            margin-bottom: 1rem;
        }

        .carousel-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: var(--radius-md);
            display: none;
        }

        .carousel-image.active {
            display: block;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(10, 25, 41, 0.8);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--color-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .carousel-nav:hover {
            background: var(--color-accent);
            color: var(--color-bg-primary);
        }

        .carousel-nav.prev {
            left: 1rem;
        }

        .carousel-nav.next {
            right: 1rem;
        }

        .carousel-thumbnails {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition);
        }

        .thumbnail.active,
        .thumbnail:hover {
            opacity: 1;
            border-color: var(--color-accent);
        }

        .carousel-indicators {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            cursor: pointer;
            transition: var(--transition);
        }

        .indicator.active {
            background: var(--color-accent);
            transform: scale(1.2);
        }

        /* --- Cart --- */
        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 1rem;
            padding: 1rem;
            background: rgba(16, 42, 61, 0.5);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .cart-item-info h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .cart-item-info .price {
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-controls button {
            width: 30px;
            height: 30px;
            background: var(--color-accent);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-bg-primary);
            font-weight: 700;
            cursor: pointer;
        }

        .quantity-controls span {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .cart-item-total {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
        }

        .cart-item-total .price {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .cart-summary {
            border-top: 1px solid var(--color-border);
            padding-top: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .summary-row.total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-accent);
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
        }

        /* --- Wishlist --- */
        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .wishlist-item {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 1rem;
            transition: var(--transition);
        }

        .wishlist-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .wishlist-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }

        .wishlist-info h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .wishlist-info .category {
            font-size: 0.75rem;
            color: var(--color-info);
            display: block;
            margin-bottom: 0.5rem;
        }

        .wishlist-info .price {
            font-weight: 700;
            color: var(--color-accent);
        }

        .wishlist-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* --- Image Preview --- */
        #imagePreview {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 2px solid var(--color-border);
        }

        .preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Filters --- */
        .filters-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }

        .search-container input {
            padding-left: 2.5rem;
        }

        .search-container i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* --- Categories --- */
        .categories-list {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .category-chip {
            padding: 0.5rem 1rem;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        .category-chip.active,
        .category-chip:hover {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
        }

        /* --- Empty State --- */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-text-muted);
        }

        .empty-state .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
        }

        /* --- Toast Notifications --- */
        #toastContainer {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-left: 5px solid var(--color-success);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            min-width: 300px;
            box-shadow: var(--shadow-lg);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-error { border-left-color: var(--color-danger); }
        .toast-warning { border-left-color: var(--color-warning); }
        .toast-info { border-left-color: var(--color-info); }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-error .toast-icon { color: var(--color-danger); }
        .toast-warning .toast-icon { color: var(--color-warning); }
        .toast-success .toast-icon { color: var(--color-success); }
        .toast-info .toast-icon { color: var(--color-info); }

        /* --- Loading Overlay --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 41, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--color-border);
            border-top: 5px solid var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay p {
            margin-top: 1rem;
            color: var(--color-text-muted);
        }

        /* --- FAB --- */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 90;
        }

        .fab:hover {
            transform: scale(1.1);
            background: #4cd4b8;
        }

        .fab.hide {
            display: none;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                max-width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .cart-item {
                grid-template-columns: 60px 1fr;
                gap: 0.75rem;
            }
            .cart-item img {
                width: 60px;
                height: 60px;
            }
            .cart-item-total {
                grid-column: 1 / -1;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo" onclick="App.navigate('home')">
                    <i class="fas fa-leaf"></i> Laboratorios Kumi
                </a>
                <nav>
                    <ul>
                        <li><a href="#" onclick="App.scrollToProducts()">Productos</a></li>
                        <li><a href="#" onclick="App.navigate('profile')">Mi Perfil</a></li>
                        <li><a href="#" onclick="App.navigate('orders')">Mis Pedidos</a></li>
                    </ul>
                </nav>
                <div class="nav-actions">
                    <button class="icon-btn" onclick="App.toggleWishlist()" aria-label="Ver favoritos">
                        <i class="fas fa-heart"></i>
                        <span id="wishlistBadge" class="badge" style="display: none;">0</span>
                    </button>
                    <button class="icon-btn" onclick="App.toggleCart()" aria-label="Ver carrito">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartBadge" class="badge" style="display: none;">0</span>
                    </button>
                    <div id="userMenuContainer" style="position: relative;">
                        <button id="userBtn" class="icon-btn" onclick="App.toggleUserMenu()" style="display: none;" aria-label="Menú de usuario">
                            <i class="fas fa-user"></i>
                        </button>
                        <button id="adminBtn" class="btn btn-secondary" onclick="App.navigate('auth')">
                            <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                        </button>
                        <!-- User Menu Dropdown -->
                        <div id="userMenu" class="modal" style="position: absolute; top: 100%; right: 0; width: 250px; background: var(--color-bg-secondary); border-radius: var(--radius-md); padding: 0; display: none;">
                            <div class="modal-header" style="padding: 1rem;">
                                <div id="userMenuHeader" style="display: flex; align-items: center; gap: 1rem;">
                                    <!-- User info will be injected here -->
                                </div>
                            </div>
                            <div style="padding: 0 1rem 1rem;">
                                <button class="btn btn-outline btn-block" onclick="App.navigate('profile')"><i class="fas fa-user-circle"></i> Mi Perfil</button>
                                <button class="btn btn-outline btn-block" onclick="App.navigate('orders')"><i class="fas fa-box"></i> Mis Pedidos</button>
                                <button id="logoutBtn" class="btn btn-danger btn-block" onclick="App.logoutUser()" style="display: none;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Home Section -->
        <section id="homeSection">
            <div id="about" style="text-align: center; padding: 4rem 0;">
                <h1 class="section-title">Bienvenidos a Laboratorios Kumi</h1>
                <p class="section-subtitle">Tu fuente confiable de productos naturales y medicinales para el bienestar integral.</p>
                <button class="btn btn-primary" onclick="App.scrollToProducts()">
                    <i class="fas fa-arrow-down"></i> Explorar Productos
                </button>
            </div>
        </section>

        <!-- Products Section -->
        <section id="productos">
            <h2 class="section-title">Nuestros Productos</h2>
            <p class="section-subtitle">Descubre nuestra selección de alta calidad</p>

            <!-- Filters Bar -->
            <div class="filters-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar productos..." onkeyup="App.filterProducts()">
                </div>
                <div class="filter-controls">
                    <select id="sortSelect" onchange="App.filterProducts()">
                        <option value="relevance">Más Relevantes</option>
                        <option value="price-asc">Precio: Menor a Mayor</option>
                        <option value="price-desc">Precio: Mayor a Menor</option>
                        <option value="name-asc">Nombre: A-Z</option>
                    </select>
                    <button class="icon-btn" onclick="App.toggleView()" aria-label="Cambiar vista">
                        <i id="viewIcon" class="fas fa-th"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="App.clearFilters()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>

            <!-- Categories List -->
            <div id="categoriesList" class="categories-list"></div>

            <!-- Results Count -->
            <p id="resultsCount" style="margin-bottom: 1rem; color: var(--color-text-muted);"></p>

            <!-- Products Grid -->
            <div id="productsGrid" class="products-grid"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2024 Laboratorios Kumi. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- FAB Add Product (Admin) -->
    <button id="fabAddProduct" class="fab hide" onclick="App.showProductForm()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- =================== MODALS =================== -->

    <!-- Auth Modal -->
    <div id="authSection" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Mi Cuenta</h2>
                <button class="close-btn" onclick="App.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Login Form -->
                <form id="loginForm" onsubmit="App.loginUser(event)">
                    <h3>Iniciar Sesión</h3>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="userPassword">Contraseña</label>
                        <input type="password" id="userPassword" required>
                    </div>
                    <p id="loginError" class="toast-error" style="display: none; padding: 0.5rem; border-radius: var(--radius-sm);"></p>
                    <button type="submit" class="btn btn-primary btn-block">Iniciar Sesión</button>
                </form>

                <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--color-border);">

                <!-- Register Form -->
                <form id="registerForm" onsubmit="App.registerUser(event)">
                    <h3>Registrarse</h3>
                    <div class="form-group">
                        <label for="regName">Nombre Completo</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Contraseña</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Teléfono (Opcional)</label>
                        <input type="tel" id="regPhone">
                    </div>
                     <p id="registerError" class="toast-error" style="display: none; padding: 0.5rem; border-radius: var(--radius-sm);"></p>
                    <button type="submit" class="btn btn-secondary btn-block">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Form Modal -->
    <div id="productFormModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="productFormTitle" class="modal-title">Agregar Nuevo Producto</h2>
                <button class="close-btn" onclick="App.closeModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="App.saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Nombre del Producto *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productSku">SKU *</label>
                        <input type="text" id="productSku" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productCategory">Categoría *</label>
                    <select id="productCategory" required></select>
                </div>
                <div class="form-group">
                    <label for="productDescription">Descripción *</label>
                    <textarea id="productDescription" rows="4" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Precio (Gs.) *</label>
                        <input type="number" id="productPrice" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Inicial *</label>
                        <input type="number" id="productStock" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productUnit">Unidad (ej. g, ml, unidades)</label>
                        <input type="text" id="productUnit">
                    </div>
                    <div class="form-group">
                        <label for="productPresentation">Presentación (ej. 100g, 500ml)</label>
                        <input type="text" id="productPresentation">
                    </div>
                </div>
                <div class="form-group">
                    <label for="productOrigin">Origen</label>
                    <input type="text" id="productOrigin">
                </div>
                <div class="form-group">
                    <label for="productTags">Etiquetas (separadas por coma)</label>
                    <input type="text" id="productTags" placeholder="ej. orgánico, digestivo, antioxidante">
                </div>
                
                <hr style="margin: 2rem 0;">

                <h4>Imágenes del Producto</h4>
                <div class="form-group">
                    <button type="button" class="btn btn-outline" onclick="App.selectFiles()">
                        <i class="fas fa-upload"></i> Subir desde Archivo
                    </button>
                    <button type="button" class="btn btn-outline" onclick="App.openCamera()">
                        <i class="fas fa-camera"></i> Usar Cámara
                    </button>
                    <button type="button" class="btn btn-outline" onclick="App.openGoogleDrive()">
                        <i class="fab fa-google-drive"></i> Google Drive
                    </button>
                    <button type="button" class="btn btn-outline" onclick="App.enterURL()">
                        <i class="fas fa-link"></i> Ingresar URL
                    </button>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="App.handleFileSelect(this.files)">
                </div>
                <div id="imagePreview"></div>

                <hr style="margin: 2rem 0;">

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productFeatured"> Producto Destacado
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productActive" checked> Activo (Visible en la tienda)
                    </label>
                </div>

                <div class="form-group" style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="App.saveAsDraft()">Guardar Borrador</button>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-shopping-cart"></i> Tu Carrito</h2>
                <button class="close-btn" onclick="App.closeModal()">&times;</button>
            </div>
            <div id="cartContent"></div>
        </div>
    </div>

    <!-- Wishlist Modal -->
    <div id="wishlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-heart"></i> Tus Favoritos</h2>
                <button class="close-btn" onclick="App.closeModal()">&times;</button>
            </div>
            <div id="wishlistContent"></div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Tomar Foto</h2>
                <button class="close-btn" onclick="App.closeCameraModal()">&times;</button>
            </div>
            <div id="cameraContainer">
                <video id="cameraVideo" autoplay style="width: 100%; border-radius: var(--radius-md);"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
                <div class="camera-controls">
                    <button class="btn btn-primary" onclick="App.takePhoto()">
                        <i class="fas fa-camera"></i> Capturar
                    </button>
                    <button class="btn btn-danger" onclick="App.closeCameraModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Section (Hidden by default) -->
    <section id="profileSection" class="container" style="display: none;">
        <h2 class="section-title">Mi Perfil</h2>
        <div id="profileContent" class="product-card" style="padding: 2rem;">
            <!-- Profile info will be injected here -->
        </div>
    </section>

    <!-- Orders Section (Hidden by default) -->
    <section id="ordersSection" class="container" style="display: none;">
        <h2 class="section-title">Mis Pedidos</h2>
        <div id="ordersContent" class="orders-list">
            <!-- Orders will be injected here -->
        </div>
    </section>

    <script>
    /**
     * Mock Google API for demonstration purposes.
     * In a real application, this would be replaced with actual API calls to Google Sheets and Drive.
     */
    const GoogleAPI = {
        // Simulated database
        _db: {
            'Productos': [],
            'Usuarios': [],
            'Pedidos': [],
            'Borradores': []
        },
        _init() {
            // Populate with sample data on first load
            if (this._db['Productos'].length === 0) {
                this._db['Productos'] = [
                    { id: "1", nombre: "Boldo en Hojas - Polvo para Infusión", categoria: "Plantas Medicinales", precio: 25000, descripcion: "Boldo (Peumus boldus) de alta calidad, ideal para infusiones digestivas. Propiedades hepatoprotectoras y colagogas.", imagenes: ["https://picsum.photos/seed/boldo/400/300.jpg"], etiquetas: ["digestivo", "hígado", "natural"], stock: 50, sku: "BOL001", unidad: "g", presentacion: "100g", origen: "Chile", destacado: true, activo: true, creado: "2023-05-15", modificado: new Date().toISOString() },
                    { id: "2", nombre: "Té Verde Sencha Premium", categoria: "Tés e Infusiones", precio: 45000, descripcion: "Té verde japonés de alta calidad, rico en antioxidantes y catequinas. Ideal para metabolismo y concentración.", imagenes: ["https://picsum.photos/seed/teverde/400/300.jpg"], etiquetas: ["antioxidante", "metabolismo", "energía"], stock: 30, sku: "TVS002", unidad: "g", presentacion: "200g", origen: "Japón", destacado: true, activo: true, creado: "2023-06-20", modificado: new Date().toISOString() },
                    { id: "3", nombre: "Arnica Crema - Alivio Muscular", categoria: "Cremas y Ungüentos", precio: 35000, descripcion: "Crema de Arnica Montana para aliviar dolores musculares, contusiones y golpes. De absorción rápida.", imagenes: ["https://picsum.photos/seed/arnica/400/300.jpg"], etiquetas: ["dolor", "muscular", "antiinflamatorio"], stock: 75, sku: "ARN003", unidad: "ml", presentacion: "60ml", origen: "Local", destacado: false, activo: true, creado: "2023-07-10", modificado: new Date().toISOString() },
                    { id: "4", nombre: "Set de Tés Relajantes", categoria: "Tés e Infusiones", precio: 55000, descripcion: "Set de 3 tés (Manzanilla, Lavanda, Tila) ideales para relajar el cuerpo y la mente antes de dormir.", imagenes: ["https://picsum.photos/seed/set-tes/400/300.jpg"], etiquetas: ["relajante", "sueño", "estrés"], stock: 25, sku: "STR004", unidad: "unidades", presentacion: "3x30g", origen: "Mixto", destacado: true, activo: true, creado: "2023-08-01", modificado: new Date().toISOString() },
                    { id: "5", nombre: "Propóleo en Spray", categoria: "Suplementos", precio: 40000, descripcion: "Propóleo puro en spray para fortalecer el sistema inmune y aliviar molestias de garganta.", imagenes: ["https://picsum.photos/seed/propoleo/400/300.jpg"], etiquetas: ["inmune", "garganta", "antibiótico natural"], stock: 60, sku: "PRO005", unidad: "ml", presentacion: "30ml", origen: "Local", destacado: false, activo: true, creado: "2023-09-05", modificado: new Date().toISOString() },
                ];
                // Add a default admin user
                this._db['Usuarios'].push([
                    'admin-01', 'admin@kumi.com', 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3', // 'password'
                    'Administrador Kumi', '0000000000', '', 'https://picsum.photos/seed/admin/150/150.jpg', 'TRUE'
                ]);
            }
        },

        async readSheet(sheetId, range) {
            this._init();
            console.log(`MOCK API: Reading sheet ${range}`);
            await this._simulateNetworkLatency();
            const sheetName = range.split('!')[0];
            return this._db[sheetName] ? [Object.keys(this._db[sheetName][0] || {}), ...this._db[sheetName].map(Object.values)] : [[]];
        },

        async appendRow(sheetId, sheetName, rowData) {
            this._init();
            console.log(`MOCK API: Appending row to ${sheetName}`, rowData);
            await this._simulateNetworkLatency();
            const headers = Object.keys(this._db[sheetName][0] || {});
            const newEntry = {};
            headers.forEach((header, index) => {
                newEntry[header] = rowData[index];
            });
            this._db[sheetName].push(newEntry);
            return true;
        },

        async updateRow(sheetId, sheetName, rowIndex, rowData) {
            this._init();
            console.log(`MOCK API: Updating row ${rowIndex} in ${sheetName}`, rowData);
            await this._simulateNetworkLatency();
            const headers = Object.keys(this._db[sheetName][0] || {});
            const updatedEntry = {};
            headers.forEach((header, index) => {
                updatedEntry[header] = rowData[index];
            });
            this._db[sheetName][rowIndex] = updatedEntry;
            return true;
        },

        async deleteRow(sheetId, sheetName, rowIndex) {
            this._init();
            console.log(`MOCK API: Deleting row ${rowIndex} in ${sheetName}`);
            await this._simulateNetworkLatency();
            this._db[sheetName].splice(rowIndex, 1);
            return true;
        },

        async uploadImageToDrive(file, folderId) {
            this._init();
            console.log(`MOCK API: Uploading image ${file.name} to folder ${folderId}`);
            await this._simulateNetworkLatency(1500); // Simulate longer upload time
            // Return a fake URL
            return `https://picsum.photos/seed/${file.name}-${Date.now()}/600/400.jpg`;
        },

        async deleteFileFromUrl(url) {
            console.log(`MOCK API: Deleting file at ${url}`);
            await this._simulateNetworkLatency();
            return true;
        },
        
        createFilePicker() {
            console.log('MOCK API: File Picker would open here.');
            // Simulate picking a file
            setTimeout(() => {
                const fakeUrl = `https://picsum.photos/seed/drive-${Date.now()}/600/400.jpg`;
                App.state.imageUploadQueue.push(fakeUrl);
                App.updateImagePreview();
                App.showToast('Imagen seleccionada de Drive', 'success');
            }, 1000);
            return null; // In a real API, this would return a picker object
        },

        _simulateNetworkLatency(ms = 800) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    };

    /**
     * Main Application Class
     */
    class App {
        // --- CONFIGURATION & STATE ---
        static config = {
            SHEET_ID: '1JFF44nFhV0HBm7L3o2f8_UzOHtGyZ255tNFAB1xniHs', // Not used in mock, but kept for structure
            DRIVE_FOLDER_ID: '1w6G3v60iCmbeUxDCguGg_3M96aKdF6nY'
        };

        static state = {
            products: [],
            filteredProducts: [],
            categories: [],
            selectedCategory: '',
            cart: [],
            wishlist: [],
            orders: [],
            currentUser: null,
            isAdmin: false,
            imageUploadQueue: [],
            viewMode: 'grid', // 'grid' or 'list'
            cameraStream: null
        };

        // --- INITIALIZATION ---
        static async init() {
            this.loadUserSession();
            this.setupEventListeners();
            await this.loadInitialData();
            this.updateUIForAuth();
            this.navigate('home');
        }

        static setupEventListeners() {
            // Close modals on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
            });
            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeModal();
                }
            });
            // Close user menu on outside click
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                const userMenuContainer = document.getElementById('userMenuContainer');
                if (!userMenuContainer.contains(e.target)) {
                    userMenu.style.display = 'none';
                }
            });
        }

        static async loadInitialData() {
            try {
                this.showLoading(true);
                const productsData = await GoogleAPI.readSheet(this.config.SHEET_ID, 'Productos!A1:Z1000');
                if (productsData.length > 1) {
                    const headers = productsData[0].map(h => this.snakeToCamel(h));
                    this.state.products = productsData.slice(1).map(row => {
                        const product = {};
                        headers.forEach((header, index) => {
                            let value = row[index];
                            // Type conversion
                            if (header === 'precio' || header === 'stock') value = parseInt(value, 10);
                            if (header === 'destacado' || header === 'activo') value = value === 'TRUE' || value === true;
                            if (header === 'etiquetas') value = value ? value.split(',').map(t => t.trim()) : [];
                            if (header === 'imagenes') value = value ? value.split(',') : [];
                            product[header] = value;
                        });
                        return product;
                    });
                } else {
                    this.loadSampleData(); // Fallback to sample data if sheet is empty
                }

                this.state.filteredProducts = [...this.state.products];
                this.extractCategories();
                this.renderCategories();
                this.renderProducts();
                this.updateMetrics();

            } catch (error) {
                console.error("Failed to load initial data:", error);
                this.showToast('Error al cargar los datos. Mostrando datos de ejemplo.', 'error');
                this.loadSampleData();
                this.state.filteredProducts = [...this.state.products];
                this.extractCategories();
                this.renderCategories();
                this.renderProducts();
                this.updateMetrics();
            } finally {
                this.showLoading(false);
            }
        }

        // --- NAVIGATION & UI CONTROL ---
        static navigate(section) {
            document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
            const targetSection = document.getElementById(`${section}Section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            if (section === 'profile') this.loadProfileData();
            if (section === 'orders') this.loadOrders();
        }

        static closeModal() {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
            this.closeCameraModal(); // Ensure camera stream is stopped
        }

        static updateUIForAuth() {
            const userBtn = document.getElementById('userBtn');
            const adminBtn = document.getElementById('adminBtn');
            const fabBtn = document.getElementById('fabAddProduct');
            const logoutBtn = document.getElementById('logoutBtn');
            const userMenuHeader = document.getElementById('userMenuHeader');

            if (this.state.currentUser) {
                userBtn.style.display = 'flex';
                adminBtn.style.display = 'none';
                userMenuHeader.innerHTML = `
                    <img src="${this.state.currentUser.avatar}" alt="${this.state.currentUser.name}" style="width: 32px; height: 32px; border-radius: 50%;">
                    <span>${this.state.currentUser.name}</span>
                `;
                logoutBtn.style.display = 'block';
                if (this.state.currentUser.isAdmin) {
                    this.state.isAdmin = true;
                    fabBtn.classList.remove('hide');
                }
            } else {
                userBtn.style.display = 'none';
                adminBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
                fabBtn.classList.add('hide');
                this.state.isAdmin = false;
            }
            this.updateBadges();
        }

        static toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        static showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        static showToast(message, type = 'success', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon"><i class="fas ${icons[type]}"></i></div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // --- PRODUCT RENDERING & FILTERING ---
        static renderProducts() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;

            if (this.state.filteredProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon"><i class="fas fa-search"></i></div>
                        <h3 class="empty-title">No se encontraron productos</h3>
                        <p class="empty-description">Intenta ajustando los filtros o el término de búsqueda.</p>
                    </div>
                `;
                this.updateResultsCount(0);
                return;
            }

            grid.innerHTML = this.state.filteredProducts.map(product => {
                const isInWishlist = this.state.wishlist.some(item => item.id === product.id);
                return `
                    <div class="product-card">
                        <div class="product-image-container">
                            ${product.destacado ? '<span class="product-badge">Destacado</span>' : ''}
                            ${this.renderProductGallery(product.imagenes)}
                            <div class="product-actions">
                                ${this.state.isAdmin ? `<button class="icon-btn" onclick="App.editProduct('${product.id}')" aria-label="Editar"><i class="fas fa-edit"></i></button>` : ''}
                                ${this.state.isAdmin ? `<button class="icon-btn" onclick="App.deleteProduct('${product.id}')" aria-label="Eliminar"><i class="fas fa-trash"></i></button>` : ''}
                                <button class="icon-btn" onclick="App.toggleWishlist('${product.id}')" aria-label="Añadir a favoritos">
                                    <i class="fas fa-heart" style="color: ${isInWishlist ? 'var(--color-danger)' : 'inherit'};"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-info">
                            <span class="product-category">${product.categoria}</span>
                            <h3 class="product-name">${product.nombre}</h3>
                            <p class="product-description">${product.descripcion}</p>
                            <div class="product-footer">
                                <span class="product-price">Gs. ${product.precio.toLocaleString()}</span>
                                <button class="btn btn-primary btn-sm" onclick="App.addToCart('${product.id}')" ${product.stock <= 0 ? 'disabled' : ''}>
                                    <i class="fas fa-cart-plus"></i> ${product.stock <= 0 ? 'Sin Stock' : 'Agregar'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            this.updateResultsCount(this.state.filteredProducts.length);
        }

        static renderProductGallery(images) {
            if (!images || images.length === 0) {
                return `<img src="https://picsum.photos/seed/default/600/400.jpg" alt="Producto" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
            // For the card view, just show the first image
            return `<img src="${images[0]}" alt="Producto" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://picsum.photos/seed/default/600/400.jpg'">`;
        }

        static filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;

            this.state.filteredProducts = this.state.products.filter(product => {
                const matchesSearch = product.nombre.toLowerCase().includes(searchTerm) ||
                                     product.descripcion.toLowerCase().includes(searchTerm) ||
                                     product.etiquetas.some(tag => tag.toLowerCase().includes(searchTerm));
                const matchesCategory = !this.state.selectedCategory || product.categoria === this.state.selectedCategory;
                return matchesSearch && matchesCategory && product.activo;
            });

            // Sorting
            this.state.filteredProducts.sort((a, b) => {
                switch (sortBy) {
                    case 'price-asc': return a.precio - b.precio;
                    case 'price-desc': return b.precio - a.precio;
                    case 'name-asc': return a.nombre.localeCompare(b.nombre);
                    default: return 0; // relevance
                }
            });

            this.renderProducts();
        }

        static extractCategories() {
            const categorySet = new Set(this.state.products.map(p => p.categoria));
            this.state.categories = Array.from(categorySet).sort();
        }

        static renderCategories() {
            const list = document.getElementById('categoriesList');
            if (!list) return;
            list.innerHTML = `<button class="category-chip ${!this.state.selectedCategory ? 'active' : ''}" onclick="App.selectCategory('')">Todos</button>` +
                this.state.categories.map(cat => `
                    <button class="category-chip ${this.state.selectedCategory === cat ? 'active' : ''}" onclick="App.selectCategory('${cat}')">${cat}</button>
                `).join('');
        }

        static selectCategory(category) {
            this.state.selectedCategory = category;
            this.renderCategories();
            this.filterProducts();
        }

        static clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'relevance';
            this.state.selectedCategory = '';
            this.renderCategories();
            this.filterProducts();
        }

        static toggleView() {
            const grid = document.getElementById('productsGrid');
            const icon = document.getElementById('viewIcon');
            if (this.state.viewMode === 'grid') {
                this.state.viewMode = 'list';
                grid.style.gridTemplateColumns = '1fr';
                icon.className = 'fas fa-list';
            } else {
                this.state.viewMode = 'grid';
                grid.style.gridTemplateColumns = '';
                icon.className = 'fas fa-th';
            }
        }

        static scrollToProducts() {
            document.getElementById('productos').scrollIntoView({ behavior: 'smooth' });
        }

        static updateResultsCount(count) {
            const countEl = document.getElementById('resultsCount');
            if (countEl) {
                countEl.textContent = `${count} producto${count !== 1 ? 's' : ''} encontrado${count !== 1 ? 's' : ''}`;
            }
        }

        // --- PRODUCT MANAGEMENT (ADMIN) ---
        static showProductForm(productId = null) {
            if (!this.state.isAdmin) {
                this.showToast('No tienes permisos para realizar esta acción', 'error');
                return;
            }
            const modal = document.getElementById('productFormModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('productFormTitle');
            form.reset();
            this.state.imageUploadQueue = [];
            this.updateImagePreview();

            if (productId) {
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;
                title.textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.nombre;
                document.getElementById('productCategory').value = product.categoria;
                document.getElementById('productDescription').value = product.descripcion;
                document.getElementById('productPrice').value = product.precio;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productSku').value = product.sku;
                document.getElementById('productUnit').value = product.unidad || '';
                document.getElementById('productPresentation').value = product.presentacion || '';
                document.getElementById('productOrigin').value = product.origen || '';
                document.getElementById('productTags').value = product.etiquetas.join(', ');
                document.getElementById('productFeatured').checked = product.destacado || false;
                document.getElementById('productActive').checked = product.activo !== false;
                this.state.imageUploadQueue = [...product.imagenes];
                this.updateImagePreview();
            } else {
                title.textContent = 'Agregar Nuevo Producto';
                document.getElementById('productId').value = this.generateId();
                document.getElementById('productActive').checked = true;
            }
            this.loadCategoriesInSelect();
            modal.classList.add('show');
        }

        static loadCategoriesInSelect() {
            const select = document.getElementById('productCategory');
            if (!select) return;
            select.innerHTML = '<option value="">Selecciona una categoría</option>' +
                this.state.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        static async saveProduct(event) {
            event.preventDefault();
            if (!this.state.isAdmin) {
                this.showToast('No tienes permisos para realizar esta acción', 'error');
                return;
            }
            const productId = document.getElementById('productId').value;
            const isEditing = this.state.products.some(p => p.id === productId);
            const productData = {
                id: productId,
                nombre: document.getElementById('productName').value.trim(),
                categoria: document.getElementById('productCategory').value,
                descripcion: document.getElementById('productDescription').value.trim(),
                imagenes: [...this.state.imageUploadQueue],
                etiquetas: document.getElementById('productTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                precio: parseInt(document.getElementById('productPrice').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                sku: document.getElementById('productSku').value.trim(),
                unidad: document.getElementById('productUnit').value.trim(),
                presentacion: document.getElementById('productPresentation').value.trim(),
                origen: document.getElementById('productOrigin').value.trim(),
                destacado: document.getElementById('productFeatured').checked,
                activo: document.getElementById('productActive').checked,
                modificado: new Date().toISOString()
            };

            if (!productData.nombre || !productData.categoria || !productData.descripcion || !productData.sku) {
                this.showToast('Completa todos los campos obligatorios', 'error');
                return;
            }
            if (productData.imagenes.length === 0) {
                this.showToast('Debes subir al menos una imagen', 'error');
                return;
            }

            try {
                this.showLoading(true);
                if (isEditing) {
                    const index = this.state.products.findIndex(p => p.id === productId);
                    if (index !== -1) {
                        productData.creado = this.state.products[index].creado;
                        this.state.products[index] = productData;
                    }
                    this.showToast('Producto actualizado correctamente', 'success');
                } else {
                    productData.creado = new Date().toISOString().split('T')[0];
                    this.state.products.push(productData);
                    this.showToast('Producto agregado correctamente', 'success');
                }
                this.state.filteredProducts = [...this.state.products];
                this.extractCategories();
                this.renderCategories();
                this.filterProducts();
                this.updateMetrics();
                this.closeModal();
            } catch (error) {
                console.error('Error guardando producto:', error);
                this.showToast('Error al guardar el producto', 'error');
            } finally {
                this.showLoading(false);
            }
        }

        static async deleteProduct(productId) {
            if (!this.state.isAdmin) {
                this.showToast('No tienes permisos para realizar esta acción', 'error');
                return;
            }
            if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
            try {
                this.showLoading(true);
                this.state.products = this.state.products.filter(p => p.id !== productId);
                this.state.filteredProducts = this.state.filteredProducts.filter(p => p.id !== productId);
                this.extractCategories();
                this.renderCategories();
                this.renderProducts();
                this.updateMetrics();
                this.showToast('Producto eliminado correctamente', 'success');
            } catch (error) {
                console.error('Error eliminando producto:', error);
                this.showToast('Error al eliminar el producto', 'error');
            } finally {
                this.showLoading(false);
            }
        }

        // --- IMAGE HANDLING ---
        static selectFiles() { document.getElementById('fileInput').click(); }
        static async handleFileSelect(files) {
            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (validFiles.length === 0) { this.showToast('Por favor selecciona archivos de imagen válidos', 'error'); return; }
            if (validFiles.length > 5) { this.showToast('Máximo 5 imágenes por producto', 'warning'); validFiles.splice(5); }
            for (const file of validFiles) {
                try {
                    this.showToast(`Subiendo ${file.name}...`, 'info');
                    const driveUrl = await GoogleAPI.uploadImageToDrive(file, this.config.DRIVE_FOLDER_ID);
                    this.state.imageUploadQueue.push(driveUrl);
                    this.updateImagePreview();
                    this.showToast(`${file.name} subido correctamente`, 'success');
                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    this.showToast(`Error al subir ${file.name}`, 'error');
                }
            }
        }

        static async openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('cameraVideo');
                const modal = document.getElementById('cameraModal');
                video.srcObject = stream;
                this.cameraStream = stream;
                modal.classList.add('show');
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                this.showToast('No se pudo acceder a la cámara. Verifica los permisos.', 'error');
            }
        }

        static takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                try {
                    const driveUrl = await GoogleAPI.uploadImageToDrive(file, this.config.DRIVE_FOLDER_ID);
                    this.state.imageUploadQueue.push(driveUrl);
                    this.updateImagePreview();
                    this.showToast('Foto capturada y subida correctamente', 'success');
                    this.closeCameraModal();
                } catch (error) {
                    console.error('Error subiendo foto:', error);
                    this.showToast('Error al guardar la foto', 'error');
                }
            }, 'image/jpeg', 0.9);
        }

        static closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('show');
            if (this.cameraStream) {
                this.cameraStream.getTracks().forEach(track => track.stop());
                this.cameraStream = null;
            }
        }

        static openGoogleDrive() {
            GoogleAPI.createFilePicker();
        }

        static enterURL() {
            const urls = prompt('Ingresa las URLs de las imágenes (separadas por coma):');
            if (urls && urls.trim()) {
                const urlArray = urls.split(',').map(url => url.trim()).filter(url => url);
                this.state.imageUploadQueue.push(...urlArray);
                this.updateImagePreview();
                this.showToast('URLs añadidas correctamente', 'success');
            }
        }

        static updateImagePreview() {
            const container = document.getElementById('imagePreview');
            if (!container) return;
            container.innerHTML = this.state.imageUploadQueue.map((url, idx) => `
                <div class="preview-item">
                    <img src="${url}" alt="Preview ${idx + 1}" onerror="this.src='https://picsum.photos/seed/preview/100/100.jpg'">
                    <button class="preview-remove" onclick="App.removeImageFromQueue(${idx})">×</button>
                </div>
            `).join('');
        }

        static removeImageFromQueue(index) {
            this.state.imageUploadQueue.splice(index, 1);
            this.updateImagePreview();
        }

        // --- AUTHENTICATION ---
        static async hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        static async loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const errorEl = document.getElementById('loginError');
            errorEl.style.display = 'none';

            try {
                const usersData = await GoogleAPI.readSheet(this.config.SHEET_ID, 'Usuarios!A1:Z1000');
                const users = usersData.slice(1);
                const hashedPassword = await this.hashPassword(password);
                const userRow = users.find(row => row[1] === email && row[2] === hashedPassword);

                if (userRow) {
                    const userData = {
                        id: userRow[0], name: userRow[3], email: userRow[1], phone: userRow[4],
                        address: userRow[5], avatar: userRow[6], isAdmin: userRow[7] === 'TRUE'
                    };
                    this.state.currentUser = userData;
                    localStorage.setItem('kumi-user-session', JSON.stringify({ user: userData, timestamp: Date.now() }));
                    this.showToast(`Bienvenido ${userData.name}`, 'success');
                    this.updateUIForAuth();
                    this.navigate('home');
                    this.closeModal();
                } else {
                    errorEl.textContent = 'Credenciales inválidas';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error en login:', error);
                this.showToast('Error al iniciar sesión', 'error');
            }
        }

        static async registerUser(event) {
            event.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const errorEl = document.getElementById('registerError');
            errorEl.style.display = 'none';

            try {
                const usersData = await GoogleAPI.readSheet(this.config.SHEET_ID, 'Usuarios!A1:Z1000');
                const emailExists = usersData.slice(1).some(row => row[1] === email);
                if (emailExists) {
                    errorEl.textContent = 'El email ya está registrado';
                    errorEl.style.display = 'block';
                    return;
                }
                const hashedPassword = await this.hashPassword(password);
                const newUser = [
                    this.generateId(), email, hashedPassword, name, phone, '',
                    'https://picsum.photos/seed/user/150/150.jpg', 'FALSE'
                ];
                await GoogleAPI.appendRow(this.config.SHEET_ID, 'Usuarios', newUser);
                this.showToast('Usuario registrado correctamente. Ahora puedes iniciar sesión.', 'success');
                // Switch to login view
                document.getElementById('registerForm').reset();
                document.getElementById('registerError').style.display = 'none';
                // Focus on login email
                document.getElementById('userEmail').focus();
            } catch (error) {
                console.error('Error en registro:', error);
                this.showToast('Error al registrar usuario', 'error');
            }
        }

        static logoutUser() {
            this.state.currentUser = null;
            this.state.isAdmin = false;
            localStorage.removeItem('kumi-user-session');
            this.showToast('Sesión cerrada correctamente', 'success');
            this.updateUIForAuth();
            this.navigate('home');
        }

        static loadUserSession() {
            const session = localStorage.getItem('kumi-user-session');
            if (session) {
                const sessionData = JSON.parse(session);
                if (Date.now() - sessionData.timestamp < 7 * 24 * 60 * 60 * 1000) { // 7 days
                    this.state.currentUser = sessionData.user;
                    this.state.isAdmin = sessionData.user.isAdmin;
                } else {
                    localStorage.removeItem('kumi-user-session');
                }
            }
        }

        static loadProfileData() {
            const content = document.getElementById('profileContent');
            if (!content || !this.state.currentUser) return;
            content.innerHTML = `
                <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                    <img src="${this.state.currentUser.avatar}" alt="${this.state.currentUser.name}" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--color-accent);">
                    <div>
                        <h2>${this.state.currentUser.name}</h2>
                        <p style="color: var(--color-text-muted);">${this.state.currentUser.email}</p>
                        <p style="color: var(--color-text-muted);">${this.state.currentUser.phone || 'Teléfono no registrado'}</p>
                        <p style="color: var(--color-text-muted);">${this.state.currentUser.address || 'Dirección no registrada'}</p>
                    </div>
                </div>
                <hr>
                <h3>Resumen de Actividad</h3>
                <p>Productos en carrito: <strong>${this.state.cart.reduce((sum, item) => sum + item.quantity, 0)}</strong></p>
                <p>Productos favoritos: <strong>${this.state.wishlist.length}</strong></p>
                <p>Pedidos realizados: <strong>${this.state.orders.length}</strong></p>
            `;
        }

        static loadOrders() {
            const content = document.getElementById('ordersContent');
            if (!content) return;
            if (this.state.orders.length === 0) {
                content.innerHTML = `<div class="empty-state"><div class="empty-icon"><i class="fas fa-box-open"></i></div><h3 class="empty-title">No tienes pedidos aún</h3><p class="empty-description">Tus compras aparecerán aquí.</p></div>`;
                return;
            }
            content.innerHTML = this.state.orders.map(order => {
                const statusClass = order.status === 'completado' ? 'status-completed' : order.status === 'cancelado' ? 'status-cancelled' : 'status-pending';
                return `
                    <div class="order-item">
                        <div class="order-header">
                            <div>
                                <strong>Pedido #${order.id}</strong>
                                <span style="color: var(--color-text-muted); margin-left: 1rem;">${new Date(order.date).toLocaleDateString()}</span>
                            </div>
                            <span class="order-status ${statusClass}">${order.status}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            ${order.items.map(item => `<p>${item.quantity}x ${item.name} - Gs. ${(item.price * item.quantity).toLocaleString()}</p>`).join('')}
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <strong>Total: Gs. ${order.total.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- CART & WISHLIST ---
        static addToCart(productId) {
            const product = this.state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                this.showToast(product ? 'Producto sin stock' : 'Producto no encontrado', 'warning');
                return;
            }
            const existingItem = this.state.cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                    this.showToast(`${product.nombre} +1 unidad`, 'success');
                } else {
                    this.showToast('Stock insuficiente', 'warning');
                }
            } else {
                this.state.cart.push({ ...product, quantity: 1 });
                this.showToast(`${product.nombre} agregado al carrito`, 'success');
            }
            this.saveLocalData();
            this.updateBadges();
            this.renderProducts(); // Re-render to update stock display if needed
        }

        static removeFromCart(productId) {
            this.state.cart = this.state.cart.filter(item => item.id !== productId);
            this.saveLocalData();
            this.updateBadges();
            this.renderCart();
        }

        static updateCartQuantity(productId, delta) {
            const item = this.state.cart.find(item => item.id === productId);
            const product = this.state.products.find(p => p.id === productId);
            if (!item || !product) return;
            const newQuantity = item.quantity + delta;
            if (newQuantity <= 0) {
                this.removeFromCart(productId);
            } else if (newQuantity <= product.stock) {
                item.quantity = newQuantity;
                this.saveLocalData();
                this.updateBadges();
                this.renderCart();
            } else {
                this.showToast('Stock insuficiente', 'warning');
            }
        }

        static toggleCart() {
            const modal = document.getElementById('cartModal');
            modal.classList.toggle('show');
            this.renderCart();
        }

        static renderCart() {
            const content = document.getElementById('cartContent');
            if (!content) return;
            if (this.state.cart.length === 0) {
                content.innerHTML = `<div class="empty-state"><div class="empty-icon"><i class="fas fa-shopping-cart"></i></div><h3 class="empty-title">Tu carrito está vacío</h3><p class="empty-description">Agrega productos para comenzar</p></div>`;
                return;
            }
            const total = this.state.cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            content.innerHTML = `
                <div class="cart-items">${this.state.cart.map(item => `
                    <div class="cart-item">
                        <img src="${item.imagenes[0]}" alt="${item.nombre}">
                        <div class="cart-item-info">
                            <h4>${item.nombre}</h4>
                            <p class="price">Gs. ${item.precio.toLocaleString()}</p>
                            <div class="quantity-controls">
                                <button onclick="App.updateCartQuantity('${item.id}', -1)">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="App.updateCartQuantity('${item.id}', 1)">+</button>
                            </div>
                        </div>
                        <div class="cart-item-total">
                            <span class="price">Gs. ${(item.precio * item.quantity).toLocaleString()}</span>
                            <button class="btn btn-sm btn-danger" onclick="App.removeFromCart('${item.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('')}</div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Subtotal:</span><span>Gs. ${total.toLocaleString()}</span></div>
                    <div class="summary-row"><span>Envío:</span><span>Gs. 0</span></div>
                    <div class="summary-row total"><span>Total:</span><span>Gs. ${total.toLocaleString()}</span></div>
                    <button class="btn btn-primary btn-block" onclick="App.checkout()"><i class="fas fa-credit-card"></i> Finalizar Compra</button>
                </div>
            `;
        }

        static async checkout() {
            if (!this.state.currentUser) {
                this.showToast('Debes iniciar sesión para comprar', 'warning');
                this.navigate('auth');
                return;
            }
            if (this.state.cart.length === 0) {
                this.showToast('Tu carrito está vacío', 'warning');
                return;
            }
            try {
                this.showLoading(true);
                const orderId = `ORD-${Date.now()}`;
                const total = this.state.cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
                const order = {
                    id: orderId, userId: this.state.currentUser.id, items: [...this.state.cart],
                    total: total, status: 'pendiente', date: new Date().toISOString(),
                    shippingAddress: this.state.currentUser.address || 'Pendiente'
                };
                this.state.orders.push(order);
                // Update stock
                for (const item of this.state.cart) {
                    const product = this.state.products.find(p => p.id === item.id);
                    if (product) product.stock -= item.quantity;
                }
                this.state.cart = [];
                this.saveLocalData();
                this.closeModal();
                this.updateBadges();
                this.renderProducts();
                this.showToast('Pedido realizado correctamente. ¡Gracias por tu compra!', 'success');
            } catch (error) {
                console.error('Error en checkout:', error);
                this.showToast('Error al procesar el pedido', 'error');
            } finally {
                this.showLoading(false);
            }
        }

        static toggleWishlist(productId) {
            const product = this.state.products.find(p => p.id === productId);
        if (!product) return;
        
        const exists = this.state.wishlist.some(item => item.id === productId);
        
        if (exists) {
            this.state.wishlist = this.state.wishlist.filter(item => item.id !== productId);
            this.showToast(`${product.nombre} eliminado de favoritos`, 'warning');
        } else {
            this.state.wishlist.push(product);
            this.showToast(`${product.nombre} añadido a favoritos`, 'success');
        }
        
        this.saveLocalData();
        this.updateBadges();
        this.renderProducts();
    }
    
    // Mostrar/ocultar wishlist
    static toggleWishlistModal() {
        const modal = document.getElementById('wishlistModal');
        modal.classList.toggle('show');
        this.renderWishlist();
    }
    
    // Render wishlist
    static renderWishlist() {
        const content = document.getElementById('wishlistContent');
        if (!content) return;
        
        if (this.state.wishlist.length === 0) {
            content.innerHTML = `
                <div class="empty-state show">
                    <div class="empty-icon"><i class="fas fa-heart"></i></div>
                    <h3 class="empty-title">No tienes favoritos</h3>
                    <p class="empty-description">Guarda productos que te interesen</p>
                </div>
            `;
            return;
        }
        
        content.innerHTML = `
            <div class="wishlist-grid">
                ${this.state.wishlist.map(item => `
                    <div class="wishlist-item">
                        <img src="${item.imagenes[0]}" alt="${item.nombre}">
                        <div class="wishlist-info">
                            <h4>${item.nombre}</h4>
                            <span class="category">${item.categoria}</span>
                            <span class="price">Gs. ${item.precio.toLocaleString()}</span>
                        </div>
                        <div class="wishlist-actions">
                            <button class="btn btn-sm btn-primary" onclick="App.addToCart('${item.id}');">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="App.toggleWishlist('${item.id}'); App.renderWishlist();">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // === UTILIDADES ===
    
    // Generar ID único
    static generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }
    
    // Convertir snake_case a camelCase
    static snakeToCamel(str) {
        return str.replace(/([-_][a-z])/g, (group) => group.toUpperCase().replace('-', '').replace('_', ''));
    }
    
    // Mostrar/ocultar loading
    static showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.remove('hide');
        } else {
            overlay.classList.add('hide');
        }
    }
    
    // Actualizar badges
    static updateBadges() {
        const cartBadge = document.getElementById('cartBadge');
        const wishlistBadge = document.getElementById('wishlistBadge');
        
        const cartCount = this.state.cart.reduce((sum, item) => sum + item.quantity, 0);
        const wishlistCount = this.state.wishlist.length;
        
        if (cartBadge) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = cartCount > 0 ? 'block' : 'none';
        }
        
        if (wishlistBadge) {
            wishlistBadge.textContent = wishlistCount;
            wishlistBadge.style.display = wishlistCount > 0 ? 'block' : 'none';
        }
    }
    
    // Actualizar métricas
    static updateMetrics() {
        const totalProducts = document.getElementById('totalProducts');
        const totalCategories = document.getElementById('totalCategories');
        const cartCount = document.getElementById('cartCount');
        
        if (totalProducts) {
            totalProducts.textContent = this.state.products.filter(p => p.activo !== false).length;
        }
        
        if (totalCategories) {
            totalCategories.textContent = this.state.categories.length;
        }
        
        if (cartCount) {
            cartCount.textContent = this.state.cart.reduce((sum, item) => sum + item.quantity, 0);
        }
    }
    
    // Guardar datos en localStorage
    static saveLocalData() {
        localStorage.setItem('kumi-cart', JSON.stringify(this.state.cart));
        localStorage.setItem('kumi-wishlist', JSON.stringify(this.state.wishlist));
        localStorage.setItem('kumi-orders', JSON.stringify(this.state.orders));
    }
    
    // Cargar datos desde localStorage
    static loadLocalData() {
        try {
            const cart = localStorage.getItem('kumi-cart');
            const wishlist = localStorage.getItem('kumi-wishlist');
            const orders = localStorage.getItem('kumi-orders');
            
            if (cart) this.state.cart = JSON.parse(cart);
            if (wishlist) this.state.wishlist = JSON.parse(wishlist);
            if (orders) this.state.orders = JSON.parse(orders);
        } catch (error) {
            console.error('Error loading local data:', error);
        }
    }
    
    // Exportar catálogo a PDF
    static async exportPDF() {
        try {
            this.showLoading(true);
            
            // En un entorno real, aquí se usaría una librería como jsPDF
            // Por ahora, solo simulamos la exportación
            setTimeout(() => {
                this.showLoading(false);
                this.showToast('Catálogo exportado correctamente', 'success');
            }, 2000);
            
        } catch (error) {
            console.error('Error exportando PDF:', error);
            this.showToast('Error al exportar PDF', 'error');
            this.showLoading(false);
        }
    }
    
    // Exportar a Excel
    static async exportExcel() {
        try {
            this.showLoading(true);
            
            // En un entorno real, aquí se usaría una librería como XLSX
            // Por ahora, solo simulamos la exportación
            setTimeout(() => {
                this.showLoading(false);
                this.showToast('Catálogo exportado a Excel correctamente', 'success');
            }, 2000);
            
        } catch (error) {
            console.error('Error exportando Excel:', error);
            this.showToast('Error al exportar Excel', 'error');
            this.showLoading(false);
        }
    }
    
    // Guardar producto en Google Sheets
    static async saveProductToSheet(product) {
        try {
            // En un entorno real, aquí se llamaría a la API de Google Sheets
            // Por ahora, solo simulamos el guardado
            console.log('Guardando producto en Google Sheets:', product);
            return true;
        } catch (error) {
            console.error('Error guardando producto en Sheets:', error);
            throw error;
        }
    }
    
    // Actualizar producto en Google Sheets
    static async updateProductInSheet(productId, product) {
        try {
            // En un entorno real, aquí se llamaría a la API de Google Sheets
            // Por ahora, solo simulamos la actualización
            console.log('Actualizando producto en Google Sheets:', productId, product);
            return true;
        } catch (error) {
            console.error('Error actualizando producto en Sheets:', error);
            throw error;
        }
    }
    
    // Eliminar producto de Google Sheets
    static async deleteProductFromSheet(productId) {
        try {
            // En un entorno real, aquí se llamaría a la API de Google Sheets
            // Por ahora, solo simulamos la eliminación
            console.log('Eliminando producto de Google Sheets:', productId);
            return true;
        } catch (error) {
            console.error('Error eliminando producto de Sheets:', error);
            throw error;
        }
    }
    
    // Cargar categorías desde productos
    static loadCategories() {
        const categories = new Set();
        this.state.products.forEach(product => {
            if (product.categoria) {
                categories.add(product.categoria);
            }
        });
        this.state.categories = Array.from(categories).sort();
    }
    
    // Renderizar categorías
    static renderCategories() {
        const container = document.getElementById('categoriesContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div class="category-chip ${this.state.selectedCategory === '' ? 'active' : ''}" onclick="App.selectCategory('')">
                Todas
            </div>
            ${this.state.categories.map(category => `
                <div class="category-chip ${this.state.selectedCategory === category ? 'active' : ''}" 
                     onclick="App.selectCategory('${category}')">
                    ${category}
                </div>
            `).join('')}
        `;
    }
    
    // Seleccionar categoría
    static selectCategory(category) {
        this.state.selectedCategory = category;
        this.filterProducts();
        this.renderCategories();
    }
    
    // Filtrar productos
    static filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sortBy = document.getElementById('sortSelect').value;
        
        this.state.filteredProducts = this.state.products.filter(product => {
            // Filtrar por término de búsqueda
            const matchesSearch = product.nombre.toLowerCase().includes(searchTerm) || 
                                  product.descripcion.toLowerCase().includes(searchTerm) ||
                                  product.etiquetas.some(tag => tag.toLowerCase().includes(searchTerm));
            
            // Filtrar por categoría
            const matchesCategory = this.state.selectedCategory === '' || product.categoria === this.state.selectedCategory;
            
            // Solo mostrar productos activos
            const isActive = product.activo !== false;
            
            return matchesSearch && matchesCategory && isActive;
        });
        
        // Ordenar productos
        switch (sortBy) {
            case 'price-asc':
                this.state.filteredProducts.sort((a, b) => a.precio - b.precio);
                break;
            case 'price-desc':
                this.state.filteredProducts.sort((a, b) => b.precio - a.precio);
                break;
            case 'name-asc':
                this.state.filteredProducts.sort((a, b) => a.nombre.localeCompare(b.nombre));
                break;
            case 'name-desc':
                this.state.filteredProducts.sort((a, b) => b.nombre.localeCompare(a.nombre));
                break;
            default:
                // Por defecto, ordenar por destacados primero
                this.state.filteredProducts.sort((a, b) => {
                    if (a.destacado && !b.destacado) return -1;
                    if (!a.destacado && b.destacado) return 1;
                    return 0;
                });
        }
        
        this.renderProducts();
        this.updateResultsCount();
    }
    
    // Cargar datos de ejemplo
    static loadSampleData() {
        console.warn('Cargando datos de ejemplo...');
        
        this.state.products = [
            {
                id: "1",
                nombre: "Boldo en Hojas - Polvo para Infusión",
                categoria: "Plantas Medicinales",
                precio: 25000,
                descripcion: "Boldo (Peumus boldus) de alta calidad, ideal para infusiones digestivas. Propiedades hepatoprotectoras y colagogas.",
                imagenes: ["https://picsum.photos/seed/boldo/400/300.jpg"],
                etiquetas: ["digestivo", "hígado", "natural"],
                stock: 50,
                sku: "BOL001",
                unidad: "g",
                presentacion: "100g",
                origen: "Chile",
                destacado: true,
                activo: true,
                creado: "2023-05-15",
                modificado: new Date().toISOString()
            },
            {
                id: "2",
                nombre: "Té Verde Sencha Premium",
                categoria: "Tés e Infusiones",
                precio: 45000,
                descripcion: "Té verde japonés de alta calidad, rico en antioxidantes y catequinas. Ideal para metabolismo y concentración.",
                imagenes: ["https://picsum.photos/seed/teverde/400/300.jpg"],
                etiquetas: ["antioxidante", "metabolismo", "energía"],
                stock: 30,
                sku: "TVS002",
                unidad: "g",
                presentacion: "200g",
                origen: "Japón",
                destacado: true,
                activo: true,
                creado: "2023-06-20",
                modificado: new Date().toISOString()
            },
            {
                id: "3",
                nombre: "Aceite de Copaiba",
                categoria: "Aceites Esenciales",
                precio: 35000,
                descripcion: "Aceite de Copaiba puro con propiedades antiinflamatorias y analgésicas. Ideal para masajes terapéuticos.",
                imagenes: ["https://picsum.photos/seed/copaiba/400/300.jpg"],
                etiquetas: ["antiinflamatorio", "dolor", "natural"],
                stock: 20,
                sku: "ACE003",
                unidad: "ml",
                presentacion: "30ml",
                origen: "Brasil",
                destacado: false,
                activo: true,
                creado: "2023-07-10",
                modificado: new Date().toISOString()
            }
        ];
        
        this.state.filteredProducts = [...this.state.products];
        this.loadCategories();
    }
    }
    
    // Inicialización cuando DOM está listo
    document.addEventListener('DOMContentLoaded', function() {
        App.init();
    });
